import React, { useState, useEffect } from 'react';
import { RefreshCw, TrendingUp, AlertCircle, Download, Filter } from 'lucide-react';

const StockScoutApp = () => {
  const [stocks, setStocks] = useState([]);
  const [loading, setLoading] = useState(false);
  const [progress, setProgress] = useState(0);
  const [lastUpdate, setLastUpdate] = useState(null);
  const [filters, setFilters] = useState({
    minScore: 65,
    minPrice: 100,
    maxPrice: 1200,
    sectors: [],
    mode: 'all'
  });
  const [sortConfig, setSortConfig] = useState({ key: 'score', direction: 'desc' });

  const sectors = ['IT', 'Banking', 'Pharma', 'Auto', 'FMCG', 'Energy', 'Metals', 'Realty'];
  
  // Simulated stock data generator for demo
  const generateMockData = () => {
    const symbols = [
      'RELIANCE', 'TCS', 'HDFCBANK', 'INFY', 'ICICIBANK', 'HDFC', 'SBIN', 'BHARTIARTL',
      'ITC', 'KOTAKBANK', 'LT', 'AXISBANK', 'ASIANPAINT', 'MARUTI', 'TITAN',
      'SUNPHARMA', 'ULTRACEMCO', 'NESTLEIND', 'BAJFINANCE', 'HCLTECH',
      'WIPRO', 'M&M', 'NTPC', 'POWERGRID', 'TATASTEEL', 'INDUSINDBK', 'ADANIPORTS',
      'COALINDIA', 'ONGC', 'TECHM', 'BAJAJFINSV', 'HINDALCO', 'DRREDDY', 'GRASIM',
      'BRITANNIA', 'DIVISLAB', 'SHREECEM', 'CIPLA', 'EICHERMOT', 'JSWSTEEL'
    ];

    const sectorMap = {
      'RELIANCE': 'Energy', 'TCS': 'IT', 'HDFCBANK': 'Banking', 'INFY': 'IT',
      'ICICIBANK': 'Banking', 'HDFC': 'Banking', 'SBIN': 'Banking', 'BHARTIARTL': 'Telecom',
      'ITC': 'FMCG', 'KOTAKBANK': 'Banking', 'LT': 'Infra', 'AXISBANK': 'Banking',
      'ASIANPAINT': 'Paints', 'MARUTI': 'Auto', 'TITAN': 'Retail',
      'SUNPHARMA': 'Pharma', 'ULTRACEMCO': 'Cement', 'NESTLEIND': 'FMCG',
      'BAJFINANCE': 'NBFC', 'HCLTECH': 'IT', 'WIPRO': 'IT', 'M&M': 'Auto',
      'NTPC': 'Power', 'POWERGRID': 'Power', 'TATASTEEL': 'Metals',
      'INDUSINDBK': 'Banking', 'ADANIPORTS': 'Ports', 'COALINDIA': 'Coal',
      'ONGC': 'Oil&Gas', 'TECHM': 'IT', 'BAJAJFINSV': 'NBFC', 'HINDALCO': 'Metals',
      'DRREDDY': 'Pharma', 'GRASIM': 'Cement', 'BRITANNIA': 'FMCG',
      'DIVISLAB': 'Pharma', 'SHREECEM': 'Cement', 'CIPLA': 'Pharma',
      'EICHERMOT': 'Auto', 'JSWSTEEL': 'Metals'
    };

    return symbols.map(symbol => {
      const price = Math.random() * 1000 + 150;
      const atr = Math.random() * 30 + 8;
      const score = Math.floor(Math.random() * 40) + 60;
      const volumeMult = (Math.random() * 3 + 2).toFixed(1);
      const rsi = Math.floor(Math.random() * 30) + 55;
      const expectedMove = atr * (1.5 + Math.random() * 0.5);
      const breakoutType = ['VWAP', 'Range', 'High'][Math.floor(Math.random() * 3)];

      return {
        symbol,
        ltp: price.toFixed(2),
        score,
        volumeMult,
        atr: atr.toFixed(2),
        expectedMove: expectedMove.toFixed(2),
        expectedMovePct: ((expectedMove / price) * 100).toFixed(2),
        rsi,
        sector: sectorMap[symbol] || 'Others',
        breakoutType
      };
    }).filter(s => s.score >= 65).sort((a, b) => b.score - a.score);
  };

  const scanMarket = async () => {
    setLoading(true);
    setProgress(0);
    
    // Simulate scanning progress
    for (let i = 0; i <= 100; i += 10) {
      await new Promise(resolve => setTimeout(resolve, 200));
      setProgress(i);
    }
    
    const data = generateMockData();
    setStocks(data);
    setLastUpdate(new Date());
    setLoading(false);
  };

  useEffect(() => {
    scanMarket();
  }, []);

  const filteredStocks = stocks.filter(stock => {
    if (stock.score < filters.minScore) return false;
    if (parseFloat(stock.ltp) < filters.minPrice || parseFloat(stock.ltp) > filters.maxPrice) return false;
    if (filters.sectors.length > 0 && !filters.sectors.includes(stock.sector)) return false;
    return true;
  });

  const sortedStocks = [...filteredStocks].sort((a, b) => {
    const aVal = a[sortConfig.key];
    const bVal = b[sortConfig.key];
    const modifier = sortConfig.direction === 'asc' ? 1 : -1;
    return (parseFloat(aVal) - parseFloat(bVal)) * modifier;
  });

  const handleSort = (key) => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc'
    }));
  };

  const downloadCSV = () => {
    const headers = ['Symbol', 'LTP', 'Score', 'Volume Mult', 'ATR', 'Expected Move (₹)', 'Expected Move (%)', 'RSI', 'Sector', 'Breakout Type'];
    const rows = sortedStocks.map(s => [
      s.symbol, s.ltp, s.score, s.volumeMult, s.atr, s.expectedMove, s.expectedMovePct, s.rsi, s.sector, s.breakoutType
    ]);
    
    const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stock_scout_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };

  const sectorHeatmap = sectors.map(sector => ({
    sector,
    count: stocks.filter(s => s.sector === sector && s.score >= 70).length
  })).sort((a, b) => b.count - a.count);

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-4xl font-bold mb-2 flex items-center gap-3">
              <TrendingUp className="text-green-400" size={40} />
              ₹20-₹30 Stock Scout — India
            </h1>
            <p className="text-gray-400">NSE Market Scanner • Real-time Opportunity Finder</p>
          </div>
          <button
            onClick={scanMarket}
            disabled={loading}
            className="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 disabled:from-gray-600 disabled:to-gray-700 px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition-all transform hover:scale-105"
          >
            <RefreshCw className={loading ? 'animate-spin' : ''} size={20} />
            {loading ? 'Scanning...' : 'Refresh Scan'}
          </button>
        </div>

        {/* Progress Bar */}
        {loading && (
          <div className="mb-6 bg-slate-800 rounded-lg p-4">
            <div className="flex justify-between mb-2 text-sm">
              <span>Scanning NSE stocks...</span>
              <span>{progress}%</span>
            </div>
            <div className="w-full bg-slate-700 rounded-full h-3">
              <div 
                className="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-300"
                style={{ width: `${progress}%` }}
              />
            </div>
          </div>
        )}

        {/* Stats Bar */}
        <div className="grid grid-cols-4 gap-4 mb-6">
          <div className="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-slate-700">
            <div className="text-gray-400 text-sm mb-1">Total Opportunities</div>
            <div className="text-3xl font-bold text-green-400">{sortedStocks.length}</div>
          </div>
          <div className="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-slate-700">
            <div className="text-gray-400 text-sm mb-1">Avg Score</div>
            <div className="text-3xl font-bold text-blue-400">
              {sortedStocks.length > 0 ? Math.round(sortedStocks.reduce((a, b) => a + b.score, 0) / sortedStocks.length) : 0}
            </div>
          </div>
          <div className="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-slate-700">
            <div className="text-gray-400 text-sm mb-1">High Score (≥80)</div>
            <div className="text-3xl font-bold text-yellow-400">
              {sortedStocks.filter(s => s.score >= 80).length}
            </div>
          </div>
          <div className="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-slate-700">
            <div className="text-gray-400 text-sm mb-1">Last Updated</div>
            <div className="text-lg font-semibold text-gray-300">
              {lastUpdate ? lastUpdate.toLocaleTimeString() : '--:--:--'}
            </div>
          </div>
        </div>

        {/* Filters & Heatmap Section */}
        <div className="grid grid-cols-3 gap-6 mb-6">
          {/* Filters */}
          <div className="col-span-2 bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
            <div className="flex items-center gap-2 mb-4">
              <Filter size={20} className="text-blue-400" />
              <h3 className="text-xl font-semibold">Filters</h3>
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm text-gray-400 mb-2">Min Score: {filters.minScore}</label>
                <input
                  type="range"
                  min="60"
                  max="100"
                  value={filters.minScore}
                  onChange={(e) => setFilters({...filters, minScore: parseInt(e.target.value)})}
                  className="w-full"
                />
              </div>
              
              <div>
                <label className="block text-sm text-gray-400 mb-2">Price Range</label>
                <div className="flex gap-2">
                  <input
                    type="number"
                    value={filters.minPrice}
                    onChange={(e) => setFilters({...filters, minPrice: parseInt(e.target.value)})}
                    className="w-full bg-slate-700 rounded px-3 py-2 text-sm"
                    placeholder="Min"
                  />
                  <input
                    type="number"
                    value={filters.maxPrice}
                    onChange={(e) => setFilters({...filters, maxPrice: parseInt(e.target.value)})}
                    className="w-full bg-slate-700 rounded px-3 py-2 text-sm"
                    placeholder="Max"
                  />
                </div>
              </div>
            </div>

            <div className="mt-4">
              <label className="block text-sm text-gray-400 mb-2">Mode</label>
              <select
                value={filters.mode}
                onChange={(e) => setFilters({...filters, mode: e.target.value})}
                className="w-full bg-slate-700 rounded px-3 py-2"
              >
                <option value="all">All</option>
                <option value="intraday">Intraday Only</option>
                <option value="swing">Swing (1-5 Days)</option>
              </select>
            </div>
          </div>

          {/* Sector Heatmap */}
          <div className="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
            <h3 className="text-xl font-semibold mb-4">Sector Heatmap</h3>
            <div className="space-y-2">
              {sectorHeatmap.slice(0, 6).map(item => (
                <div key={item.sector} className="flex justify-between items-center">
                  <span className="text-sm">{item.sector}</span>
                  <div className="flex items-center gap-2">
                    <div className="w-20 bg-slate-700 rounded-full h-2">
                      <div 
                        className="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full"
                        style={{ width: `${Math.min(100, item.count * 10)}%` }}
                      />
                    </div>
                    <span className="text-sm font-semibold text-green-400 w-6">{item.count}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Download Button */}
        <div className="mb-4 flex justify-end">
          <button
            onClick={downloadCSV}
            className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition-all"
          >
            <Download size={18} />
            Download CSV
          </button>
        </div>

        {/* Stock Table */}
        <div className="bg-slate-800/50 backdrop-blur rounded-lg border border-slate-700 overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-slate-900/80">
                <tr>
                  {[
                    { key: 'symbol', label: 'Symbol' },
                    { key: 'ltp', label: 'LTP (₹)' },
                    { key: 'score', label: 'Score' },
                    { key: 'volumeMult', label: 'Vol Mult' },
                    { key: 'atr', label: 'ATR' },
                    { key: 'expectedMove', label: 'Exp Move (₹)' },
                    { key: 'expectedMovePct', label: 'Exp Move (%)' },
                    { key: 'rsi', label: 'RSI' },
                    { key: 'sector', label: 'Sector' },
                    { key: 'breakoutType', label: 'Breakout' }
                  ].map(col => (
                    <th
                      key={col.key}
                      onClick={() => handleSort(col.key)}
                      className="px-4 py-3 text-left text-sm font-semibold cursor-pointer hover:bg-slate-800 transition-colors"
                    >
                      {col.label}
                      {sortConfig.key === col.key && (
                        <span className="ml-1">{sortConfig.direction === 'desc' ? '↓' : '↑'}</span>
                      )}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {sortedStocks.map((stock, idx) => (
                  <tr 
                    key={stock.symbol}
                    className="border-t border-slate-700 hover:bg-slate-700/30 transition-colors"
                  >
                    <td className="px-4 py-3 font-semibold text-blue-300">{stock.symbol}</td>
                    <td className="px-4 py-3">₹{stock.ltp}</td>
                    <td className="px-4 py-3">
                      <span className={`px-3 py-1 rounded-full font-semibold text-sm ${
                        stock.score >= 80 ? 'bg-green-500/20 text-green-300' :
                        stock.score >= 70 ? 'bg-yellow-500/20 text-yellow-300' :
                        'bg-blue-500/20 text-blue-300'
                      }`}>
                        {stock.score}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-green-400">{stock.volumeMult}x</td>
                    <td className="px-4 py-3">₹{stock.atr}</td>
                    <td className="px-4 py-3 font-semibold text-green-400">₹{stock.expectedMove}</td>
                    <td className="px-4 py-3 font-semibold text-green-400">{stock.expectedMovePct}%</td>
                    <td className="px-4 py-3">{stock.rsi}</td>
                    <td className="px-4 py-3">
                      <span className="px-2 py-1 bg-slate-700 rounded text-xs">{stock.sector}</span>
                    </td>
                    <td className="px-4 py-3">
                      <span className="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs">
                        {stock.breakoutType}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* Disclaimer */}
        <div className="mt-6 bg-yellow-900/20 border border-yellow-700/50 rounded-lg p-4 flex items-start gap-3">
          <AlertCircle className="text-yellow-400 mt-1" size={20} />
          <div className="text-sm text-yellow-200">
            <strong>Disclaimer:</strong> This is a scouting tool for educational purposes only. Not investment advice. 
            No guarantee of returns. Past patterns do not predict future performance. Always do your own research 
            and consult a financial advisor before trading.
          </div>
        </div>
      </div>
    </div>
  );
};

export default StockScoutApp;
